import{E as P}from"./index-DQKEvUsp.js";import{_ as w,e as C,c as S,a as m,b as f,w as g,F as H,r as d,o as _,d as y}from"./index-DQxC938F.js";import"./CesiumEarth-D0reHEmA.js";class b{constructor(t,e,o,i){t&&e&&o&&(this.viewer=t,this.positions=e,this.height=o,this.precision=i||256,this.maxHeigh=-1e4,this.entitypolygon=[],this.createPolygonGeo(this.positions))}setHeight(t){this.height=t,this.deleteEntity()}setprecision(t){this.precision=t,this.createPolygonGeo(this.positions)}createPolygonGeo(t){let e=Math.PI/Math.pow(2,11);e=e/this.precision;let o=new Cesium.PolygonGeometry.fromPositions({positions:t,vertexFormat:Cesium.PerInstanceColorAppearance.FLAT_VERTEX_FORMAT,granularity:e});this.geom=new Cesium.PolygonGeometry.createGeometry(o)}VolumeAnalysis(){var t=0,e=0,o=0,i=0,h=0;const s=this.geom.indices,a=this.geom.attributes.position.values;for(let r=0;r<s.length;r+=3){let n=this.returnPosition(a,s[r],s[r+1],s[r+2]);this.addpolygon(n.pos0,n.pos1,n.pos2);const p=this.computeArea4Triangle(n.pos0.bottomHeightPos,n.pos1.bottomHeightPos,n.pos2.bottomHeightPos),u=(n.pos0.height+n.pos1.height+n.pos2.height)/3;u<this.height?(o+=p,i=i+p*(this.height-u)):(t+=p,e=e=p*(u-this.height))}const l=t+o+h;return this.result={allArea:l,cutArea:t,cutVolume:e,fillArea:o,fillVolume:i},this.addlabel(),this.result}computeArea4Triangle(t,e,o){let i=Cesium.Cartesian3.distance(t,e),h=Cesium.Cartesian3.distance(e,o),s=Cesium.Cartesian3.distance(o,t),a=(i+h+s)/2;return Math.sqrt(a*(a-i)*(a-h)*(a-s))}returnPosition(t,e,o,i){let h=new Cesium.Cartesian3(t[e*3],t[e*3+1],t[e*3+2]),s=Cesium.Cartographic.fromCartesian(h),a=this.viewer.scene.sampleHeightSupported?this.viewer.scene.sampleHeight(s):this.viewer.scene.globe.getHeight(s);a>this.maxHeigh&&(this.maxHeigh=a);let l=new Cesium.Cartesian3(t[o*3],t[o*3+1],t[o*3+2]),r=Cesium.Cartographic.fromCartesian(l),n=this.viewer.scene.sampleHeightSupported?this.viewer.scene.sampleHeight(s):this.viewer.scene.globe.getHeight(s);n>this.maxHeigh&&(this.maxHeigh=n);let p=new Cesium.Cartesian3(t[i*3],t[i*3+1],t[i*3+2]),u=Cesium.Cartographic.fromCartesian(p),c=this.viewer.scene.sampleHeightSupported?this.viewer.scene.sampleHeight(s):this.viewer.scene.globe.getHeight(s);return c>this.maxHeigh&&(this.maxHeigh=c),{pos0:{topheightPos:Cesium.Cartesian3.fromRadians(s.longitude,s.latitude,a),bottomHeightPos:Cesium.Cartesian3.fromRadians(s.longitude,s.latitude,0),height:a},pos1:{topheightPos:Cesium.Cartesian3.fromRadians(r.longitude,r.latitude,n),bottomHeightPos:Cesium.Cartesian3.fromRadians(r.longitude,r.latitude,0),height:n},pos2:{topheightPos:Cesium.Cartesian3.fromRadians(u.longitude,u.latitude,c),bottomHeightPos:Cesium.Cartesian3.fromRadians(u.longitude,u.latitude,0),height:c}}}addpolygon(t,e,o){let i=this.viewer.entities.add({polygon:{hierarchy:[t.topheightPos,e.topheightPos,o.topheightPos],perPositionHeight:!0,material:Cesium.Color.fromRandom(),extrudedHeight:this.height,outline:!0,outlineColor:Cesium.Color.BLACK}});this.entitypolygon.push(i)}computeCentroidOfPolygon(){let t=this.positions;for(var e=[],o=[],i=0;i<t.length;i++){var h=Cesium.Cartographic.fromCartesian(t[i]);e.push(h.longitude),o.push(h.latitude)}var s=0,a=0,l=0,r=0,n=0,p=0,u=0,c=0;for(i=0;i<t.length;i++)s=e[i],a=o[i],i==t.length-1?(l=e[0],r=o[0]):(l=e[i+1],r=o[i+1]),p=s*r-l*a,n+=p,u+=(s+l)*p,c+=(a+r)*p;return n*=.5,u/=6*n,c/=6*n,new Cesium.Cartographic(u,c)}addlabel(){let t=this.computeCentroidOfPolygon(),e=viewer.entities.add({position:Cesium.Cartesian3.fromRadians(t.longitude,t.latitude,this.height+20),label:{text:"填挖总面积(㎡)："+this.result.allArea+`
填方体积(m³)：`+this.result.fillVolume+`
挖方体积(m³)：`+this.result.cutVolume,showBackground:!0,font:"20px monospace",horizontalOrigin:Cesium.HorizontalOrigin.LEFT,verticalOrigin:Cesium.VerticalOrigin.TOP,pixelOffset:new Cesium.Cartesian2(15,0)}});this.label=e}deleteEntity(){this.entitypolygon&&(this.entitypolygon.forEach(t=>{this.viewer.entities.remove(t)}),this.entitypolygon=[]),this.viewer.entities.remove(this.label)}deleteAll(){this.deleteEntity(),this.viewer="",this.positions="",this.height="",this.precision="",this.maxHeigh=""}}class A{constructor(t){if(!t)throw new Error("no viewer object!");this.viewer=t,this.handler=void 0,this.init()}init(){this.activeShapePoints=[],this.floatingPoint=void 0,this.activeShape=void 0,this.activePoints=[],this.initHandler()}start(t){const e=this;e.keyDownStatus(!0),e.init(),e.handler=new Cesium.ScreenSpaceEventHandler(e.viewer.canvas),e.handler.setInputAction(function(o){let i=e.viewer.scene.pickPosition(o.position);if(Cesium.defined(i)){if(e.activeShapePoints.length===0){e.floatingPoint=e.createPoint(i),e.activeShapePoints.push(i);let h=new Cesium.CallbackProperty(function(){return new Cesium.PolygonHierarchy(e.activeShapePoints)},!1);e.activeShape=e.drawShape(h)}e.activeShapePoints.push(i),e.createPoint(i)}},Cesium.ScreenSpaceEventType.LEFT_CLICK),e.handler.setInputAction(function(o){if(Cesium.defined(e.floatingPoint)){let i=e.viewer.scene.pickPosition(o.endPosition);Cesium.defined(i)&&(e.floatingPoint.position.setValue(i),e.activeShapePoints.pop(),e.activeShapePoints.push(i))}},Cesium.ScreenSpaceEventType.MOUSE_MOVE),e.handler.setInputAction(function(){e.activeShapePoints.pop(),e.activeShapePoints.length&&(e.polygon=e.drawShape(e.activeShapePoints)),e.viewer.entities.remove(e.floatingPoint),e.viewer.entities.remove(e.activeShape),e.activePoints.forEach(o=>{e.viewer.entities.remove(o)}),e.handler.destroy(),setTimeout(()=>{typeof t=="function"&&t()},1e3)},Cesium.ScreenSpaceEventType.RIGHT_CLICK)}initHandler(){this.handler&&(this.handler.destroy(),this.handler=void 0)}createPoint(t){let e=this.viewer.entities.add({position:t,point:{color:Cesium.Color.SKYBLUE,pixelSize:5}});return this.activePoints.push(e),e}drawShape(t){return this.viewer.entities.add({polygon:{hierarchy:t,material:new Cesium.ColorMaterialProperty(Cesium.Color.BLUE.withAlpha(.4))}})}keyDownStatus(t){const e=this;document.onkeydown=function(o){if(o.ctrlKey&&window.event.keyCode==90){if(!t)return!1;e.activeShapePoints.pop(),e.viewer.entities.remove(e.activePoints[e.activePoints.length-1]),e.activePoints.pop()}}}Cartesian3ToDgrees(t){let e=window.viewer.scene.globe.ellipsoid.cartesianToCartographic(t),o=Cesium.Math.toDegrees(e.latitude),i=Cesium.Math.toDegrees(e.longitude),h=e.height;return{lng:i,lat:o,alt:h}}}const x={class:"toolPane"},V={style:{"text-align":"center"}},E={__name:"index",setup(v){const t=C("left"),e=C(200),o=C(100);let i=null;const h=()=>{let a=new A(viewer);a.start(function(){viewer.scene.globe.depthTestAgainstTerrain=!0,i=new b(viewer,a.activeShapePoints,e.value,o.value),i.VolumeAnalysis(),viewer.entities.remove(a.polygon)})},s=()=>{i.deleteAll()};return(a,l)=>{const r=d("el-input-number"),n=d("el-form-item"),p=d("el-form"),u=d("el-button");return _(),S(H,null,[m(P),f("div",x,[m(p,{"label-position":t.value,"label-width":"auto"},{default:g(()=>[m(n,{label:"基准面高度"},{default:g(()=>[m(r,{modelValue:e.value,"onUpdate:modelValue":l[0]||(l[0]=c=>e.value=c),max:1e4,min:1},null,8,["modelValue"])]),_:1}),m(n,{label:"精度数值  "},{default:g(()=>[m(r,{modelValue:o.value,"onUpdate:modelValue":l[1]||(l[1]=c=>o.value=c),max:1e4,min:1},null,8,["modelValue"])]),_:1})]),_:1},8,["label-position"]),f("div",V,[m(u,{type:"primary",onClick:h},{default:g(()=>l[2]||(l[2]=[y("填挖分析")])),_:1}),m(u,{type:"warning",onClick:s},{default:g(()=>l[3]||(l[3]=[y("一键清除")])),_:1})])])],64)}}},R=w(E,[["__scopeId","data-v-d6337d5a"]]);export{R as default};
