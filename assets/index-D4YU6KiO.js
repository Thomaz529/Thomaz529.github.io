import{E as x}from"./index-hnr1oFTy.js";import{p as T,t as A,u as M,C as E}from"./CesiumEarth-DSJv-lZu.js";import{_ as D,c as R,a as P,b,w as _,F as L,r as O,o as k,d as S,p as V,e as z}from"./index-Do2SFHFE.js";class I{constructor(e,i){e&&i&&(this.canvasEle=i,this.viewer=e,this.handler=void 0,this.lightCamera,this.pyramid,this.frustumPrimitive,this.viewershedPolygon)}initHandler(){this.handler&&(this.handler.destroy(),this.handler=void 0)}createViewshedAnalysis(e){let i=this,t=i.viewer.scene;i.initHandler(),i.clearAll(),i.handler=new Cesium.ScreenSpaceEventHandler(i.viewer.canvas),i.handler.setInputAction(s=>{t.screenSpaceCameraController.enableRotate=!1,t.screenSpaceCameraController.enableZoom=!1,t.globe.depthTestAgainstTerrain=!0;let a=t.pickPosition(s.position),n=i.cartesian3ToDegree(a);i.handler.setInputAction(function(r){let o=t.pickPosition(r.endPosition);if(Cesium.defined(o)){let l=i.cartesian3ToDegree(o),h=Cesium.Cartesian3.distance(o,a),c=i.getAngle(n[0],n[1],l[0],l[1]),u=i.getPitch(a,o);i.ViewShedOptions={viewPosition:a,endPosition:o,direction:c,pitch:u,horizontalViewAngle:90,verticalViewAngle:60,visibleAreaColor:Cesium.Color.GREEN,invisibleAreaColor:Cesium.Color.RED,visualRange:h},i.updateViewShed()}},Cesium.ScreenSpaceEventType.MOUSE_MOVE)},Cesium.ScreenSpaceEventType.LEFT_DOWN),i.handler.setInputAction(()=>{i.initHandler(),t.screenSpaceCameraController.enableRotate=!0,t.screenSpaceCameraController.enableZoom=!0,i.drawViewershed(e)},Cesium.ScreenSpaceEventType.LEFT_UP)}ReturnDistance(e,i){let t=Cesium.Cartographic.fromCartesian(e),s=Cesium.Cartographic.fromCartesian(i),a=new Cesium.EllipsoidGeodesic;return a.setEndPoints(t,s),a.surfaceDistance}getHeight(e,i,t){let s=Cesium.Cartographic.fromDegrees(e,i);return this.viewer.scene.sampleHeight(s,t)}cartesian3ToDegree(e){let t=this.viewer.scene.globe.ellipsoid.cartesianToCartographic(e),s=Cesium.Math.toDegrees(t.latitude),a=Cesium.Math.toDegrees(t.longitude),n=t.height;return[a,s,n]}getAngle(e,i,t,s){let a=Math.atan2(Math.abs(e-t),Math.abs(i-s));return t>=e?a=s<i?Math.PI-a:a:a=s>=i?2*Math.PI-a:Math.PI+a,a=a*180/Math.PI,a}getPitch(e,i){let t=Cesium.Transforms.eastNorthUpToFixedFrame(e);const s=Cesium.Cartesian3.subtract(i,e,new Cesium.Cartesian3);let a=Cesium.Matrix4.multiplyByPointAsVector(Cesium.Matrix4.inverse(t,t),s,s);return Cesium.Cartesian3.normalize(a,a),Cesium.Math.PI_OVER_TWO-Cesium.Math.acosClamped(a.z)}updateViewShed(){this.clear(),this.setLightCamera(),this.addVisualPyramid(),this.createFrustum()}clear(){this.pyramid&&(this.viewer.entities.removeById(this.pyramid.id),this.pyramid=void 0),this.frustumPrimitive&&(this.viewer.scene.primitives.remove(this.frustumPrimitive),this.frustumPrimitive=void 0),this.debugModelMatrixPrimitive&&(this.viewer.scene.primitives.remove(this.debugModelMatrixPrimitive),this.debugModelMatrixPrimitive=void 0)}clearAll(){this.clear(),this.viewershedPolygon&&(this.viewer.scene.primitives.remove(this.viewershedPolygon),this.viewershedPolygon=void 0)}addVisualPyramid(){let e=this.ViewShedOptions,i=e.viewPosition,t=Number(e.visualRange),s=Cesium.Transforms.eastNorthUpToFixedFrame(i);this.debugModelMatrixPrimitive=this.viewer.scene.primitives.add(new Cesium.DebugModelMatrixPrimitive({modelMatrix:s,length:5}));const a=e.horizontalViewAngle/2,n=e.verticalViewAngle/2,r=Cesium.Math.toDegrees(e.pitch),o=new Cesium.EllipsoidGraphics({radii:new Cesium.Cartesian3(t,t,t),minimumClock:Cesium.Math.toRadians(90-e.direction-a),maximumClock:Cesium.Math.toRadians(90-e.direction+a),minimumCone:Cesium.Math.toRadians(90-r-n),maximumCone:Cesium.Math.toRadians(90-r+n),fill:!1,outline:!0,subdivisions:256,stackPartitions:64,slicePartitions:64,outlineColor:Cesium.Color.YELLOWGREEN.withAlpha(.5)}),l=new Cesium.Entity({position:i,ellipsoid:o});this.pyramid=this.viewer.entities.add(l)}setLightCamera(){this.lightCamera||(this.lightCamera=new Cesium.Camera(this.viewer.scene));let e=this.ViewShedOptions,i=Number(e.visualRange);this.lightCamera.position=e.viewPosition,this.lightCamera.frustum.near=.1,this.lightCamera.frustum.far=i;const t=Cesium.Math.toRadians(e.horizontalViewAngle),s=Cesium.Math.toRadians(e.verticalViewAngle);this.lightCamera.frustum.aspectRatio=i*Math.tan(t/2)*2/(i*Math.tan(s/2)*2),this.lightCamera.frustum.fov=t>s?t:s,this.lightCamera.setView({destination:e.viewPosition,orientation:{heading:Cesium.Math.toRadians(e.direction||0),pitch:e.pitch||0,roll:0}})}createFrustum(){const e=new Cesium.Cartesian3,i=new Cesium.Matrix3,t=new Cesium.Quaternion,s=this.lightCamera.directionWC,a=this.lightCamera.upWC;let n=this.lightCamera.rightWC;n=Cesium.Cartesian3.negate(n,e);let r=i;Cesium.Matrix3.setColumn(r,0,n,r),Cesium.Matrix3.setColumn(r,1,a,r),Cesium.Matrix3.setColumn(r,2,s,r);let o=Cesium.Quaternion.fromRotationMatrix(r,t),l=new Cesium.GeometryInstance({geometry:new Cesium.FrustumOutlineGeometry({frustum:this.lightCamera.frustum,origin:this.ViewShedOptions.viewPosition,orientation:o}),id:"视椎体轮廓线"+Math.random().toString(36).substr(2),attributes:{color:Cesium.ColorGeometryInstanceAttribute.fromColor(new Cesium.Color(0,1,0,1)),show:new Cesium.ShowGeometryInstanceAttribute(!0)}});this.frustumPrimitive=this.viewer.scene.primitives.add(new Cesium.Primitive({geometryInstances:l,appearance:new Cesium.PerInstanceColorAppearance({flat:!0,translucent:!1,closed:!0})}))}add(e){let i=new Cesium.PolygonGeometry({polygonHierarchy:new Cesium.PolygonHierarchy(Cesium.Cartesian3.fromDegreesArray(e)),height:0,extrudedHeight:0,vertexFormat:Cesium.PerInstanceColorAppearance.VERTEX_FORMAT,stRotation:0,ellipsoid:Cesium.Ellipsoid.WGS84,granularity:Cesium.Math.RADIANS_PER_DEGREE,perPositionHeight:!1,closeTop:!0,closeBottom:!0,arcType:Cesium.ArcType.GEODESIC}),t=new Cesium.GeometryInstance({geometry:i,name:"ViewershedPolygon",attributes:{color:Cesium.ColorGeometryInstanceAttribute.fromColor(Cesium.Color.BLUE.withAlpha(.6)),show:new Cesium.ShowGeometryInstanceAttribute(!0)}});this.viewershedPolygon=this.viewer.scene.primitives.add(new Cesium.GroundPrimitive({geometryInstances:t,appearance:new Cesium.EllipsoidSurfaceAppearance({aboveGround:!0,material:new Cesium.Material({fabric:{type:"Image",uniforms:{image:this.returnImgae()}}})})}))}drawViewershed(e){const i=this.cartesian3ToDegree(this.ViewShedOptions.viewPosition),t=this.ViewShedOptions.visualRange,s=this.ViewShedOptions.direction;let a=this.computeBoundaryOptions(i,t,s);const n=a.bbox;let r=T([a.boundaryPoints]);const o=this.ViewShedOptions.visualRange/(e*1e3);let l=A(n,o,{mask:r}),h=this.createTargetPoints(l,o,i),c=M.train(h.values,h.lngs,h.lats,"exponential",0,100),u=M.grid([a.boundaryPoints],c,o/1e3);const m=["#ff000080","#ff000080","#ff000080","#ff000080","#ff000080","#ff000080","#00ff0080","#00ff0080","#00ff0080","#00ff0080","#00ff0080","#00ff0080"];this.canvasEle.width=3840,this.canvasEle.height=2160,M.plot(this.canvasEle,u,[n[0],n[2]],[n[1],n[3]],m),this.add(a.positionArr)}computeBoundaryOptions(e,i,t){let s=6378137,a=6356725;const n=e[0],r=e[1],o=[n,r,n,r];let l=[],h=[];l.push(n,r),h.push([n,r]);let c=t+45>360?t-45-360:t-45,u=c+90;for(let m=c;m<=u;m++){let d=i*Math.sin(m*Math.PI/180),g=i*Math.cos(m*Math.PI/180),p=a+(s-a)*(90-r)/90,w=p*Math.cos(r*Math.PI/180),f=n+d/w*180/Math.PI,C=r+g/p*180/Math.PI;l.push(f,C),h.push([f,C]),this.refreshBBox(o,f,C)}return h.push([n,r]),{positionArr:l,boundaryPoints:h,bbox:o}}refreshBBox(e,i,t){e[0]=i<e[0]?i:e[0],e[1]=t<e[1]?t:e[1],e[2]=i>e[2]?i:e[2],e[3]=t>e[3]?t:e[3]}createTargetPoints(e,i,t){let s=[],a=[this.frustumPrimitive,this.pyramid,this.debugModelMatrixPrimitive],n=[],r=[],o=[],l=this.getHeight(t[0],t[1],a);s.push({x:t[0],y:t[1],z:l});let h=this.ViewShedOptions.viewPosition;for(let c=0;c<e.features.length;c++){const m=e.features[c].geometry.coordinates,d=m[0],g=m[1];let p=this.getHeight(d,g,a),w=Cesium.Cartesian3.fromDegrees(d,g,p),f=Cesium.Cartesian3.normalize(Cesium.Cartesian3.subtract(w,h,new Cesium.Cartesian3),new Cesium.Cartesian3),C=new Cesium.Ray(h,f),y=this.viewer.scene.pickFromRay(C,a);y&&(this.ReturnDistance(w,y.position)>i?n.push(0):n.push(1),r.push(d),o.push(g))}return{values:n,lngs:r,lats:o}}returnImgae(){return this.canvasEle.toDataURL("image/png")}}class F{constructor(e){e&&(this.viewer=e,this.viewPosition=null,this.viewPositionEnd=null,this.viewDistance=null,this.viewHeading=null,this.viewPitch=null,this.horizontalViewAngle=null,this.verticalViewAngle=null,this.visibleAreaColor=Cesium.Color.GREEN,this.invisibleAreaColor=Cesium.Color.RED,this.enabled=!0,this.softShadows=!0,this.size=2048)}add(){this.createLightCamera(),this.createShadowMap(),this.drawFrustumOutline(),this.drawSketch(),this.createPostStage()}update(){this.clear(),this.add()}initHandler(){this.handler&&(this.handler.destroy(),this.handler=void 0)}createViewshedAnalysis(e,i,t){var s=e,a=i,n=t,r=null;this.size=n,this.handler=new Cesium.ScreenSpaceEventHandler(this.viewer.scene.canvas),this.handler.setInputAction(o=>{this.viewer.scene.screenSpaceCameraController.enableRotate=!1,this.viewer.scene.screenSpaceCameraController.enableZoom=!1;var l=this.viewer.scene.pickPosition(o.position);l&&(this.viewPosition=l,this.viewPositionEnd=l,this.horizontalViewAngle=s,this.verticalViewAngle=a,this.handler.setInputAction(h=>{r=this.viewer.scene.pickPosition(h.endPosition),r&&(this.updatePosition(r),this.sketch||this.drawSketch())},Cesium.ScreenSpaceEventType.MOUSE_MOVE))},Cesium.ScreenSpaceEventType.LEFT_DOWN),this.handler.setInputAction(o=>{this.initHandler(),r=this.viewer.scene.pickPosition(o.position),this.updatePosition(r),this.update(),this.viewer.scene.screenSpaceCameraController.enableRotate=!0,this.viewer.scene.screenSpaceCameraController.enableZoom=!0},Cesium.ScreenSpaceEventType.LEFT_UP)}updatePosition(e){this.viewPositionEnd=e,this.viewDistance=Cesium.Cartesian3.distance(this.viewPosition,this.viewPositionEnd),this.viewHeading=this.getHeading(this.viewPosition,this.viewPositionEnd),this.viewPitch=this.getPitch(this.viewPosition,this.viewPositionEnd)}clear(){this.sketch&&(this.viewer.entities.remove(this.sketch),this.sketch=null),this.postStage&&(this.viewer.scene.postProcessStages.remove(this.postStage),this.postStage=null)}delete(){this.sketch&&(this.viewer.entities.remove(this.sketch),this.sketch=null),this.frustumOutline&&(this.viewer.scene.primitives.remove(this.frustumOutline),this.frustumOutline=null),this.postStage&&(this.viewer.scene.postProcessStages.remove(this.postStage),this.postStage=null)}createLightCamera(){this.lightCamera=new Cesium.Camera(this.viewer.scene),this.lightCamera.position=this.viewPosition,this.lightCamera.frustum.near=this.viewDistance*.001,this.lightCamera.frustum.far=this.viewDistance;const e=Cesium.Math.toRadians(this.horizontalViewAngle),i=Cesium.Math.toRadians(this.verticalViewAngle),t=this.viewDistance*Math.tan(e/2)*2/(this.viewDistance*Math.tan(i/2)*2);this.lightCamera.frustum.aspectRatio=t,e>i?this.lightCamera.frustum.fov=e:this.lightCamera.frustum.fov=i,this.lightCamera.setView({destination:this.viewPosition,orientation:{heading:Cesium.Math.toRadians(this.viewHeading||0),pitch:Cesium.Math.toRadians(this.viewPitch||0),roll:0}})}createShadowMap(){this.shadowMap=new Cesium.ShadowMap({context:this.viewer.scene.context,lightCamera:this.lightCamera,enabled:this.enabled,isPointLight:!0,pointLightRadius:this.viewDistance,cascadesEnabled:!1,size:this.size,softShadows:this.softShadows,normalOffset:!1,fromLightSource:!1}),this.viewer.scene.shadowMap=this.shadowMap}createPostStage(){const e=`
 #define USE_CUBE_MAP_SHADOW true
 uniform sampler2D colorTexture;
 uniform sampler2D depthTexture;
 in vec2 v_textureCoordinates;
 uniform mat4 camera_projection_matrix;
 uniform mat4 camera_view_matrix;
 uniform samplerCube shadowMap_textureCube;
 uniform mat4 shadowMap_matrix;
 uniform vec4 shadowMap_lightPositionEC;
 uniform vec4 shadowMap_normalOffsetScaleDistanceMaxDistanceAndDarkness;
 uniform vec4 shadowMap_texelSizeDepthBiasAndNormalShadingSmooth;
 uniform float helsing_viewDistance; 
 uniform vec4 helsing_visibleAreaColor;
 uniform vec4 helsing_invisibleAreaColor;

 struct zx_shadowParameters
 {
     vec3 texCoords;
     float depthBias;
     float depth;
     float nDotL;
     vec2 texelStepSize;
     float normalShadingSmooth;
     float darkness;
 };
 
 float czm_shadowVisibility(samplerCube shadowMap, zx_shadowParameters shadowParameters)
 {
     float depthBias = shadowParameters.depthBias;
     float depth = shadowParameters.depth;
     float nDotL = shadowParameters.nDotL;
     float normalShadingSmooth = shadowParameters.normalShadingSmooth;
     float darkness = shadowParameters.darkness;
     vec3 uvw = shadowParameters.texCoords;
     depth -= depthBias;
     float visibility = czm_shadowDepthCompare(shadowMap, uvw, depth);
     return czm_private_shadowVisibility(visibility, nDotL, normalShadingSmooth, darkness);
 }
 vec4 getPositionEC(){
     return czm_windowToEyeCoordinates(gl_FragCoord);
 }
 vec3 getNormalEC(){
     return vec3(1.);
 }
 vec4 toEye(in vec2 uv,in float depth){
     vec2 xy=vec2((uv.x*2.-1.),(uv.y*2.-1.));
     vec4 posInCamera=czm_inverseProjection*vec4(xy,depth,1.);
     posInCamera=posInCamera/posInCamera.w;
     return posInCamera;
 }
 vec3 pointProjectOnPlane(in vec3 planeNormal,in vec3 planeOrigin,in vec3 point){
     vec3 v01=point-planeOrigin;
     float d=dot(planeNormal,v01);
     return(point-planeNormal*d);
 }
 float getDepth(in vec4 depth){
     float z_window=czm_unpackDepth(depth);
     z_window=czm_reverseLogDepth(z_window);
     float n_range=czm_depthRange.near;
     float f_range=czm_depthRange.far;
     return(2.*z_window-n_range-f_range)/(f_range-n_range);
 }
 float shadow(in vec4 positionEC){
     vec3 normalEC=getNormalEC();
     zx_shadowParameters shadowParameters;
     shadowParameters.texelStepSize=shadowMap_texelSizeDepthBiasAndNormalShadingSmooth.xy;
     shadowParameters.depthBias=shadowMap_texelSizeDepthBiasAndNormalShadingSmooth.z;
     shadowParameters.normalShadingSmooth=shadowMap_texelSizeDepthBiasAndNormalShadingSmooth.w;
     shadowParameters.darkness=shadowMap_normalOffsetScaleDistanceMaxDistanceAndDarkness.w;
     vec3 directionEC=positionEC.xyz-shadowMap_lightPositionEC.xyz;
     float distance=length(directionEC);
     directionEC=normalize(directionEC);
     float radius=shadowMap_lightPositionEC.w;
     if(distance>radius)
     {
         return 2.0;
     }
     vec3 directionWC=czm_inverseViewRotation*directionEC;
     shadowParameters.depth=distance/radius-0.0003;
     shadowParameters.nDotL=clamp(dot(normalEC,-directionEC),0.,1.);
     shadowParameters.texCoords=directionWC;
     float visibility=czm_shadowVisibility(shadowMap_textureCube,shadowParameters);
     return visibility;
 }
 bool visible(in vec4 result)
 {
     result.x/=result.w;
     result.y/=result.w;
     result.z/=result.w;
     return result.x>=-1.&&result.x<=1.
     &&result.y>=-1.&&result.y<=1.
     &&result.z>=-1.&&result.z<=1.;
 }
 void main(){
     // 釉色 = 结构二维(颜色纹理, 纹理坐标)
     out_FragColor = texture(colorTexture, v_textureCoordinates);
     // 深度 = 获取深度(结构二维(深度纹理, 纹理坐标))
     float depth = getDepth(texture(depthTexture, v_textureCoordinates));
     // 视角 = (纹理坐标, 深度)
     vec4 viewPos = toEye(v_textureCoordinates, depth);
     // 世界坐标
     vec4 wordPos = czm_inverseView * viewPos;
     // 虚拟相机中坐标
     vec4 vcPos = camera_view_matrix * wordPos;
     float near = .001 * helsing_viewDistance;
     float dis = length(vcPos.xyz);
     if(dis > near && dis < helsing_viewDistance){
         // 透视投影
         vec4 posInEye = camera_projection_matrix * vcPos;
         // 可视区颜色
         // vec4 helsing_visibleAreaColor=vec4(0.,1.,0.,.5);
         // vec4 helsing_invisibleAreaColor=vec4(1.,0.,0.,.5);
         if(visible(posInEye)){
             float vis = shadow(viewPos);
             if(vis > 0.3){
                 out_FragColor = mix(out_FragColor,helsing_visibleAreaColor,.5);
             } else{
                 out_FragColor = mix(out_FragColor,helsing_invisibleAreaColor,.5);
             }
         }
     }
 }`,i=new Cesium.PostProcessStage({fragmentShader:e,uniforms:{shadowMap_textureCube:()=>(this.shadowMap.update(Reflect.get(this.viewer.scene,"_frameState")),Reflect.get(this.shadowMap,"_shadowMapTexture")),shadowMap_matrix:()=>(this.shadowMap.update(Reflect.get(this.viewer.scene,"_frameState")),Reflect.get(this.shadowMap,"_shadowMapMatrix")),shadowMap_lightPositionEC:()=>(this.shadowMap.update(Reflect.get(this.viewer.scene,"_frameState")),Reflect.get(this.shadowMap,"_lightPositionEC")),shadowMap_normalOffsetScaleDistanceMaxDistanceAndDarkness:()=>{this.shadowMap.update(Reflect.get(this.viewer.scene,"_frameState"));const t=this.shadowMap._pointBias;return Cesium.Cartesian4.fromElements(t.normalOffsetScale,this.shadowMap._distance,this.shadowMap.maximumDistance,0,new Cesium.Cartesian4)},shadowMap_texelSizeDepthBiasAndNormalShadingSmooth:()=>{this.shadowMap.update(Reflect.get(this.viewer.scene,"_frameState"));const t=this.shadowMap._pointBias,a=new Cesium.Cartesian2;return a.x=1/this.shadowMap._textureSize.x,a.y=1/this.shadowMap._textureSize.y,Cesium.Cartesian4.fromElements(a.x,a.y,t.depthBias,t.normalShadingSmooth,new Cesium.Cartesian4)},camera_projection_matrix:this.lightCamera.frustum.projectionMatrix,camera_view_matrix:this.lightCamera.viewMatrix,helsing_viewDistance:()=>this.viewDistance,helsing_visibleAreaColor:this.visibleAreaColor,helsing_invisibleAreaColor:this.invisibleAreaColor}});this.postStage=this.viewer.scene.postProcessStages.add(i)}drawFrustumOutline(){const e=new Cesium.Cartesian3,i=new Cesium.Matrix3,t=new Cesium.Quaternion;this.lightCamera.positionWC;const s=this.lightCamera.directionWC,a=this.lightCamera.upWC;let n=this.lightCamera.rightWC;n=Cesium.Cartesian3.negate(n,e);let r=i;Cesium.Matrix3.setColumn(r,0,n,r),Cesium.Matrix3.setColumn(r,1,a,r),Cesium.Matrix3.setColumn(r,2,s,r);let o=Cesium.Quaternion.fromRotationMatrix(r,t),l=new Cesium.GeometryInstance({geometry:new Cesium.FrustumOutlineGeometry({frustum:this.lightCamera.frustum,origin:this.viewPosition,orientation:o}),id:Math.random().toString(36).substr(2),attributes:{color:Cesium.ColorGeometryInstanceAttribute.fromColor(Cesium.Color.YELLOWGREEN),show:new Cesium.ShowGeometryInstanceAttribute(!0)}});this.frustumOutline=this.viewer.scene.primitives.add(new Cesium.Primitive({geometryInstances:[l],appearance:new Cesium.PerInstanceColorAppearance({flat:!0,translucent:!1})}))}drawSketch(){this.sketch=this.viewer.entities.add({name:"sketch",position:this.viewPosition,orientation:new Cesium.CallbackProperty(()=>Cesium.Transforms.headingPitchRollQuaternion(this.viewPosition,Cesium.HeadingPitchRoll.fromDegrees(this.viewHeading-this.horizontalViewAngle,this.viewPitch,.5)),!1),ellipsoid:{radii:new Cesium.CallbackProperty(()=>new Cesium.Cartesian3(this.viewDistance,this.viewDistance,this.viewDistance),!1),innerRadii:new Cesium.Cartesian3(2,2,2),minimumClock:Cesium.Math.toRadians(-this.horizontalViewAngle/2),maximumClock:Cesium.Math.toRadians(this.horizontalViewAngle/2),minimumCone:Cesium.Math.toRadians(this.verticalViewAngle+7.75),maximumCone:Cesium.Math.toRadians(180-this.verticalViewAngle-7.75),fill:!1,outline:!0,subdivisions:256,stackPartitions:64,slicePartitions:64,outlineColor:Cesium.Color.YELLOWGREEN}})}getHeading(e,i){let t=new Cesium.Cartesian3,s=Cesium.Transforms.eastNorthUpToFixedFrame(e);return Cesium.Matrix4.inverse(s,s),Cesium.Matrix4.multiplyByPoint(s,i,t),Cesium.Cartesian3.normalize(t,t),Cesium.Math.toDegrees(Math.atan2(t.x,t.y))}getPitch(e,i){let t=new Cesium.Cartesian3,s=Cesium.Transforms.eastNorthUpToFixedFrame(e);return Cesium.Matrix4.inverse(s,s),Cesium.Matrix4.multiplyByPoint(s,i,t),Cesium.Cartesian3.normalize(t,t),Cesium.Math.toDegrees(Math.asin(t.z))}}class B{constructor(e){e&&(this.viewer=e,this.handler=null,this.label=null,this.startPoint=null,this.endPoint=null,this.entityPoint=[],this.polylineEntity=null,this.polylineEntityAnalysis=[],this.labeltext="")}initHandler(){this.handler&&(this.handler.destroy(),this.handler=void 0)}create(){let e=this,i=e.viewer.scene;e.initHandler(),e.deleteAll(),e.handler=new Cesium.ScreenSpaceEventHandler(e.viewer.canvas),e.handler.setInputAction(function(t){let s=e.getCatesian3FromPX(t.position);s&&(e.startPoint?(e.initHandler(),e.viewer.entities.remove(e.polylineEntity),e.viewer.entities.remove(e.label),e.polylineEntity=null,e.label=null,i.screenSpaceCameraController.enableRotate=!0,i.screenSpaceCameraController.enableZoom=!0,e.endPoint=s,e.drawPoint(e.endPoint),e.createLineOfSight(e.startPoint,e.endPoint)):(i.screenSpaceCameraController.enableRotate=!1,i.screenSpaceCameraController.enableZoom=!1,e.startPoint=s,e.drawPoint(e.startPoint),e.labeltext="移动鼠标，点击左键结束绘制",e.handler.setInputAction(function(a){let n=e.getCatesian3FromPX(a.startPosition);n&&(e.endPoint=n,e.polylineEntity||e.drawLine())},Cesium.ScreenSpaceEventType.MOUSE_MOVE)))},Cesium.ScreenSpaceEventType.LEFT_CLICK),e.handler.setInputAction(function(t){let s=e.getCatesian3FromPX(t.startPosition);e.endPoint=s,s&&(e.label||(e.labeltext="左键点击开始绘制",e.drawLable()))},Cesium.ScreenSpaceEventType.MOUSE_MOVE)}drawLine(){let e=this;var i=e.viewer.entities.add({polyline:{positions:new Cesium.CallbackProperty(function(){return[e.startPoint,e.endPoint]}),material:Cesium.Color.RED,width:5,classificationType:Cesium.ClassificationType.BOTH}});e.polylineEntity=i}drawLable(){let e=this,i=e.viewer.entities.add({position:new Cesium.CallbackProperty(function(){return e.endPoint}),label:{text:new Cesium.CallbackProperty(function(){return e.labeltext}),font:"14px monospace",showBackground:!0,horizontalOrigin:Cesium.HorizontalOrigin.LEFT,verticalOrigin:Cesium.VerticalOrigin.BOTTOM,pixelOffset:new Cesium.Cartesian2(5,5),disableDepthTestDistance:Number.POSITIVE_INFINITY}});e.label=i}drawPoint(e){let t=this.viewer.entities.add({position:e,point:{color:Cesium.Color.YELLOW,pixelSize:5}});this.entityPoint.push(t)}createLineOfSight(e,i){let t=this,s=Cesium.Cartesian3.normalize(Cesium.Cartesian3.subtract(i,e,new Cesium.Cartesian3),new Cesium.Cartesian3),a=new Cesium.Ray(e,s),n=t.viewer.scene.pickFromRay(a,t.entityPoint);if(n){let r=t.distance(e,i),o=t.distance(e,n.position);t.distance(n.position,i),r>o?(t.drawPolylineAnalysis(e,n.position,Cesium.Color.GREEN),t.drawPolylineAnalysis(n.position,i,Cesium.Color.RED)):t.drawPolylineAnalysis(e,i,Cesium.Color.GREEN)}}drawPolylineAnalysis(e,i,t){let s=this.viewer.entities.add({polyline:{positions:[e,i],width:5,material:t}});this.polylineEntityAnalysis.push(s)}distance(e,i){let t=Cesium.Cartographic.fromCartesian(e),s=Cesium.Cartographic.fromCartesian(i),a=new Cesium.EllipsoidGeodesic;a.setEndPoints(t,s);let n=a.surfaceDistance;return n=Math.sqrt(Math.pow(n,2)+Math.pow(s.height-t.height,2)),n}deleteAll(){this.handler&&(this.handler.destroy(),this.handler=void 0),this.entityPoint&&(this.entityPoint.forEach(e=>{this.viewer.entities.remove(e)}),this.entityPoint=[]),this.polylineEntityAnalysis&&(this.polylineEntityAnalysis.forEach(e=>{this.viewer.entities.remove(e)}),this.polylineEntityAnalysis=[]),this.polylineEntity&&(this.viewer.entities.remove(this.polylineEntity),this.polylineEntity=null),this.label&&(this.viewer.entities.remove(this.label),this.label=null),this.startPoint=null,this.endPoint=null}getCatesian3FromPX(e){let i=this,t=i.viewer.scene.drillPick(e),s=null,a=!1,n=!1;for(let o in t){let l=t[o];if((l&&l.primitive instanceof Cesium.Cesium3DTileFeature||l&&l.primitive instanceof Cesium.Cesium3DTileset||l&&l.primitive instanceof Cesium.Model)&&(a=!0),a&&(i.viewer.scene.pick(e),s=i.viewer.scene.pickPosition(e),s)){let h=Cesium.Cartographic.fromCartesian(s);h.height<0&&(h.height=0);let c=Cesium.Math.toDegrees(h.longitude),u=Cesium.Math.toDegrees(h.latitude),m=h.height;s=i.transformWGS84ToCartesian({lng:c,lat:u,alt:m})}}let r=i.viewer.terrainProvider instanceof Cesium.EllipsoidTerrainProvider;if(!a&&!r){let o=i.viewer.scene.camera.getPickRay(e);if(!o)return null;s=i.viewer.scene.globe.pick(o,i.viewer.scene),n=!0}if(!a&&!n&&r&&(s=i.viewer.scene.camera.pickEllipsoid(e,i.viewer.scene.globe.ellipsoid)),s){let o=i.transformCartesianToWGS84(s);return o.alt<0&&(s=i.transformWGS84ToCartesian(o,.1)),s}return!1}transformWGS84ToCartesian(e,i){return e?Cesium.Cartesian3.fromDegrees(e.lng||e.lon,e.lat,e.alt=i||e.alt,Cesium.Ellipsoid.WGS84):Cesium.Cartesian3.ZERO}transformCartesianToWGS84(e){let t=Cesium.Ellipsoid.WGS84.cartesianToCartographic(e);return{lng:Cesium.Math.toDegrees(t.longitude),lat:Cesium.Math.toDegrees(t.latitude),alt:t.height}}}class G{constructor(e,i,t){this.viewer=e,this.terrainOr3DTiles=i,this.style=t,this.handler=null,this.tempEntities=[],this.lineEntities=[],this.linePositionList=[],this.firstPoint=null,this.lastPoint=null,this.labelText="",this.tempPoints=[],this._addDisListener(),this.endDraw=!1}_addDisListener(){let e=this.viewer,i=e.scene,t=this.linePositionList,s=this.firstPoint,a=this.lastPoint;this.handler=new Cesium.ScreenSpaceEventHandler(i.canvas),this.depthTest=e.scene.globe.depthTestAgainstTerrain,this.depthTest||(e.scene.globe.depthTestAgainstTerrain=!0);let n=!1,r=!1;const o=this,l=this.terrainOr3DTiles;this.handler.setInputAction(h=>{r&&(this._reDraw(),r=!1);const c=this._getPosition(h.position,l);c&&(n?s&&(a=c.clone(),t.length===1?(t.push(a),this.labelPosition=c.clone()):t.length>1&&(t.length=0,t.push(s),t.push(a)),this.lastPoint=a,this._drawPoint(a,Cesium.Color.MEDIUMBLUE),this._getSightLines.bind(this)(l,t,u=>{o.labelText=u.labelResult,u.line_s_end?(o._drawPoint_sightline(u.line_s_end),o._drawLine_slightline([o.firstPoint,u.line_s_end],Cesium.Color.BLUE),o._drawLine_slightline([u.line_s_end,a],Cesium.Color.RED)):o._drawLine_slightline(t),o._drawResult()}),r=!0,n=!1,this.endDraw=!0):(s=c.clone(),this.firstPoint=s,this._drawPoint(s,Cesium.Color.AQUA),n=!0,t.push(s)))},Cesium.ScreenSpaceEventType.LEFT_CLICK),this.handler.setInputAction(h=>{if(n){const c=o._getPosition(h.endPosition,l);s&&(a=c.clone(),t.length===1?(t.push(a),this.labelPosition=c.clone()):t.length>1&&(t.length=0,t.push(s),t.push(a)))}},Cesium.ScreenSpaceEventType.MOUSE_MOVE)}_getPositionTest(e){const i=this.viewer,t=i.scene;var s=i.camera.pickEllipsoid(e,i.scene.globe.ellipsoid);const{lon:a,lat:n,height:r}=this._car3ToLatLon(s);console.log("椭球体表面经纬度和高度"+a+" "+n+" "+r);var o=t.pick(e);if(t.pickPositionSupported&&Cesium.defined(o)){var l=i.scene.pickPosition(e);if(Cesium.defined(l)){const{lon:h,lat:c,height:u}=this._car3ToLatLon(l);console.log("模型："+ +h+" "+c+" "+u)}}else{let h=i.camera.getPickRay(e),c=i.scene.globe.pick(h,i.scene);if(Cesium.defined(c)){const{lon:u,lat:m,height:d}=this._car3ToLatLon(c);console.log("地形表面："+ +u+" "+m+" "+d)}}}_getPosition(e,i=0){const t=this.viewer,s=t.scene;let a=null;if(i){const n=s.pick(e);if(s.pickPositionSupported&&Cesium.defined(n)){const r=t.scene.pickPosition(e);Cesium.defined(r)&&(a=r)}else{const r=t.camera.getPickRay(e),o=t.scene.globe.pick(r,t.scene);Cesium.defined(o)&&(a=o)}}else{const n=t.camera.getPickRay(e),r=t.scene.globe.pick(n,t.scene);Cesium.defined(r)&&(a=r)}return a}_computePoint(e,i){const t=this._car3ToLatLon(e),s=this._car3ToLatLon(i);let a={};return t.height>s.height?a={lon:s.lon,lat:s.lat,height:t.height}:a={lon:t.lon,lat:t.lat,height:s.height},Cesium.Cartesian3.fromDegrees(a.lon,a.lat,a.height)}_reDraw(){this.tempPoints=[],this.linePositionList.length=0;for(let e of this.tempEntities)this.viewer.entities.remove(e);this.tempEntities=[],this.firstPoint=null,this.lastPoint=null,this.xys=[]}_drawLine(e){let i=this.style.lineStyle,t=this.viewer.entities.add({polyline:i});t.polyline.positions=new Cesium.CallbackProperty(function(){return e},!1),this.lineEntities.push(t)}_drawLine_slightline(e,i=null){let t=i?{width:2,material:i}:this.style.lineStyle,s=this.viewer.entities.add({polyline:t});s.polyline.positions=e,this.tempEntities.push(s)}_drawPoint(e,i=null){let t=this.viewer.entities.add({position:e,point:{pixelSize:10,color:i||Cesium.Color.GOLD}});this.tempEntities.push(t)}_drawPoint_sightline(e){this.terrainOr3DTiles;let i=this.viewer.entities.add({position:e,point:{pixelSize:10,color:Cesium.Color.GOLD}});this.tempEntities.push(i)}_drawResult(){const e=this;var i=this.viewer.entities.add({position:e.lastPoint,label:{font:"15px sans-serif",pixelOffset:new Cesium.Cartesian2(0,-30),fillColor:new Cesium.Color(1,1,1,1),horizontalOrigin:Cesium.HorizontalOrigin.LEFT,verticalOrigin:Cesium.VerticalOrigin.BOTTOM,showBackground:!0,disableDepthTestDistance:Number.POSITIVE_INFINITY}});i.label.text="是否可通视:"+e.labelText?e.labelText:"",this.tempEntities.push(i)}_car3ToLatLon(e){let i=Cesium.Cartographic.fromCartesian(e),t=Cesium.Math.toDegrees(i.longitude),s=Cesium.Math.toDegrees(i.latitude);return{lon:t,lat:s,height:i.height}}_getSightLinesForDEM(e,i=null){const t=this._car3ToLatLon(e[0]),s=this._car3ToLatLon(e[1]);t.height>=s.height;const a=20;let n=[];for(var r=new Array(a),o=0;o<a;++o){var l=o/(a-1),h=Cesium.Math.lerp(t.lon,s.lon,l),c=Cesium.Math.lerp(t.lat,s.lat,l),u=Cesium.Math.lerp(t.height,s.height,l);n.push([h,c,u]),r[o]=Cesium.Cartesian3.lerp(e[0],e[1],l,new Cesium.Cartesian3)}const m=r.map(p=>p.clone()),d=n.map(p=>Cesium.Cartographic.fromDegrees(...p)),g=Cesium.sampleTerrainMostDetailed(viewer.terrainProvider,d);Promise.resolve(g).then(function(p){let w=null;for(let C=1;C<p.length-1;C++){const y=p[C];if(!w&&y&&y.height>n[C][2]){w=C;break}}let f=w;if(i){const C=`起点坐标：${t.lon.toFixed(2)} | ${t.lat.toFixed(2)}| ${t.height.toFixed()}
                
终点坐标：${s.lon.toFixed(2)} | ${s.lat.toFixed(2)}| ${s.height.toFixed()}
                
通视结果: ${w>0?"否":"是"}`;i({line_s_end:m[w],line_e_start:m[f],labelResult:C})}})}_getSightLines(e,i,t=null){e?this._getSightLinesFor3Dtiles(i,t):this._getSightLinesForDEM(i,t)}_getSightLinesFor3Dtiles(e,i=null){const t=this,s=this._car3ToLatLon(e[0]),a=this._car3ToLatLon(e[1]),n=20;let r=new Array(n);for(var o=0;o<n;++o){var l=o/(n-1);r[o]=Cesium.Cartesian3.lerp(e[0],e[1],l,new Cesium.Cartesian3)}const h=r.map(c=>c.clone());this.viewer.scene.clampToHeightMostDetailed(r).then(function(c){let u=null;for(let d=1;d<c.length-1;d++){const g=c[d];if(!u&&g){const p=t._car3ToLatLon(g),w=t._car3ToLatLon(h[d]);if(p.height>w.height){u=d;break}}}let m=u;if(i){const d=`起点坐标：${s.lon.toFixed(2)} | ${s.lat.toFixed(2)}| ${s.height.toFixed()}
                
终点坐标：${a.lon.toFixed(2)} | ${a.lat.toFixed(2)}| ${a.height.toFixed()}
                
通视结果: ${u>0?"否":"是"}`;i({line_s_end:h[u],line_e_start:h[m],labelResult:d})}})}_test(e,i=null){const t=this.viewer;for(var s=20,a=new Array(s),n=0;n<s;++n){var r=n/(s-1);a[n]=Cesium.Cartesian3.lerp(e[0],e[1],r,new Cesium.Cartesian3)}for(var n=0;n<s;++n)t.entities.add({position:a[n],ellipsoid:{radii:new Cesium.Cartesian3(20,20,20),material:Cesium.Color.BLUE}})}remove(){var e=this.viewer;for(let i of this.tempEntities)e.entities.remove(i);for(let i of this.lineEntities)e.entities.remove(i);this.handler&&this.handler.destroy(),e.scene.globe.depthTestAgainstTerrain=this.depthTest}}const H=v=>(V("data-v-bc7ee371"),v=v(),z(),v),N=H(()=>b("canvas",{id:"visualCanvas",style:{display:"none"}},null,-1)),W={class:"toolButton"},$={__name:"index",setup(v){const e=()=>{new E().visibilityAnalysis()},i=()=>{new E().Create3DTiles("/src/assets/3DTiles/polyBuilding/tileset.json"),new I(viewer,document.getElementById("visualCanvas")).createViewshedAnalysis(20)},t=()=>{new E().Create3DTiles("/src/assets/3DTiles/polyBuilding/tileset.json"),new F(viewer).createViewshedAnalysis(90,60,2048)},s=()=>{new E().Create3DTiles("/src/assets/3DTiles/polyBuilding/tileset.json"),new B(viewer).create()},a=()=>{new G(viewer,1,{lineStyle:{width:2,material:Cesium.Color.CHARTREUSE,clampToGround:!0}})};return(n,r)=>{const o=O("el-button");return k(),R(L,null,[P(x),N,b("div",W,[P(o,{type:"primary",onClick:e},{default:_(()=>[S("射线可视域分析")]),_:1}),P(o,{type:"primary",onClick:i},{default:_(()=>[S("圆锥可视域分析")]),_:1}),P(o,{type:"primary",onClick:t},{default:_(()=>[S("圆锥可视域分析(glsl)")]),_:1}),P(o,{type:"primary",onClick:s},{default:_(()=>[S("通视分析")]),_:1}),P(o,{type:"primary",onClick:a},{default:_(()=>[S("点通视分析(DEM)")]),_:1})])],64)}}},Y=D($,[["__scopeId","data-v-bc7ee371"]]);export{Y as default};
