import{C as y}from"./CreatePolygon-DXVtJxrI.js";import{E as x}from"./index-DQKEvUsp.js";import"./CesiumEarth-D0reHEmA.js";import{_ as W,e as H,c as M,a as p,b as f,w as C,F as D,r as d,o as I,d as w}from"./index-DQxC938F.js";class v{constructor(e){e.viewer&&(this.viewer=e.viewer,this.options=e||{},this._height=e.height||0,this.bottomImg=e.bottomImg,this.wallImg=e.wallImg,this.splitNum=Cesium.defaultValue(e.splitNum,50))}startCreate(){const e=this;y(e.viewer,[],{color:Cesium.Color.YELLOW.withAlpha(.1),outlineColor:Cesium.Color.YELLOW,outlineWidth:2},function(t){const i=t.pottingPoint;e.viewer.entities.remove(t),e.updateData(i)})}updateData(e){let t=this.viewer;this.clear();let i=[],l=Cesium.Cartesian3.subtract(e[0],e[1],new Cesium.Cartesian3).x>0;this.excavateMinHeight=9999;for(let s=0;s<e.length;++s){let r=(s+1)%e.length,o=Cesium.Cartesian3.midpoint(e[s],e[r],new Cesium.Cartesian3),n=Cesium.Cartographic.fromCartesian(e[s]),m=t.scene.globe.getHeight(n)||n.height;m<this.excavateMinHeight&&(this.excavateMinHeight=m);let u=Cesium.Cartesian3.normalize(o,new Cesium.Cartesian3),c=l?Cesium.Cartesian3.subtract(e[s],o,new Cesium.Cartesian3):Cesium.Cartesian3.subtract(e[r],o,new Cesium.Cartesian3);c=Cesium.Cartesian3.normalize(c,c);let h=Cesium.Cartesian3.cross(c,u,new Cesium.Cartesian3);h=Cesium.Cartesian3.normalize(h,h);let _=new Cesium.Plane(h,0),b=Cesium.Plane.getPointDistance(_,o);i.push(new Cesium.ClippingPlane(h,b))}this.viewer.scene.globe.clippingPlanes=new Cesium.ClippingPlaneCollection({planes:i,edgeWidth:1,edgeColor:Cesium.Color.WHITE,enabled:!0}),this.prepareWell(e),this.createWell(this.wellData),this.viewer.entities.remove(this.drawGeomtry)}clear(){this.viewer.scene.globe.clippingPlanes&&(this.viewer.scene.globe.clippingPlanes.removeAll(),this.viewer.scene.primitives.remove(this.bottomSurface),this.viewer.scene.primitives.remove(this.wellWall),this.viewer.scene.render())}prepareWell(e){let t=e.length,i=this.excavateMinHeight-this.height,a=[],l=[],s=[];for(let r=0;r<t;r++){let o=r==t-1?0:r+1,n=[Cesium.Cartographic.fromCartesian(e[r]).longitude,Cesium.Cartographic.fromCartesian(e[r]).latitude],m=[Cesium.Cartographic.fromCartesian(e[o]).longitude,Cesium.Cartographic.fromCartesian(e[o]).latitude];r==0&&(s.push(new Cesium.Cartographic(n[0],n[1])),l.push(Cesium.Cartesian3.fromRadians(n[0],n[1],i)),a.push(Cesium.Cartesian3.fromRadians(n[0],n[1],0)));for(let u=1;u<=this.splitNum;u++){let c=Cesium.Math.lerp(n[0],m[0],u/this.splitNum),h=Cesium.Math.lerp(n[1],m[1],u/this.splitNum);r==t-1&&u==this.splitNum||(s.push(new Cesium.Cartographic(c,h)),l.push(Cesium.Cartesian3.fromRadians(c,h,i)),a.push(Cesium.Cartesian3.fromRadians(c,h,0)))}}this.wellData={lerp_pos:s,bottom_pos:l,no_height_top:a}}createWell(e){let t=this;this.viewer.terrainProvider._layers?(this.createBottomSurface(e.bottom_pos),Cesium.sampleTerrainMostDetailed(this.viewer.terrainProvider,e.lerp_pos).then(function(a){let l=[];for(let s=0;s<a.length;s++){const r=a[s];let o=Cesium.Cartesian3.fromRadians(r.longitude,r.latitude,r.height);l.push(o)}t.createWellWall(e.bottom_pos,l)})):(this.createBottomSurface(e.bottom_pos),this.createWellWall(e.bottom_pos,e.no_height_top))}ellipsoidToDegree(e){let t=new Cesium.Cartesian3(e.x,e.y,e.z),i=this.viewer.scene.globe.ellipsoid.cartesianToCartographic(t);return{longitude:Cesium.Math.toDegrees(i.longitude),latitude:Cesium.Math.toDegrees(i.latitude),altitude:i.height}}createBottomSurface(e){if(e.length){let t=this.getMinHeight(e),i=[];for(let r=0;r<e.length;r++){let o=this.ellipsoidToDegree(e[r]);i.push(o.longitude,o.latitude,t)}let a=new Cesium.PolygonGeometry({polygonHierarchy:new Cesium.PolygonHierarchy(Cesium.Cartesian3.fromDegreesArrayHeights(i)),perPositionHeight:!0}),l=new Cesium.Material({fabric:{type:"Image",uniforms:{image:this.bottomImg}}}),s=new Cesium.MaterialAppearance({translucent:!1,flat:!0,material:l});this.bottomSurface=new Cesium.Primitive({geometryInstances:new Cesium.GeometryInstance({geometry:Cesium.PolygonGeometry.createGeometry(a)}),appearance:s,asynchronous:!1}),this.viewer.scene.primitives.add(this.bottomSurface)}}createWellWall(e,t){let i=this.getMinHeight(e),a=[],l=[];for(let m=0;m<t.length;m++)a.push(this.ellipsoidToDegree(t[m]).altitude),l.push(i);let s=new Cesium.WallGeometry({positions:t,maximumHeights:a,minimumHeights:l}),r=Cesium.WallGeometry.createGeometry(s),o=new Cesium.Material({fabric:{type:"Image",uniforms:{image:this.wallImg}}}),n=new Cesium.MaterialAppearance({translucent:!1,flat:!0,material:o});this.wellWall=new Cesium.Primitive({geometryInstances:new Cesium.GeometryInstance({geometry:r,attributes:{color:Cesium.ColorGeometryInstanceAttribute.fromColor(Cesium.Color.GREY)},id:"PitWall"}),appearance:n,asynchronous:!1}),this.viewer.scene.primitives.add(this.wellWall)}getMinHeight(e){let t=5e6,i=null;for(let a=0;a<e.length;a++){let l=e[a].z;l<t&&(t=l,i=this.ellipsoidToDegree(e[a]))}return i.altitude}switchExcavate(e){e?(this.viewer.scene.globe.material=null,this.wellWall.show=!0,this.bottomSurface.show=!0):(this.viewer.scene.globe.material=null,this.wellWall.show=!1,this.bottomSurface.show=!1)}updateExcavateDepth(e){this.viewer.scene.primitives.remove(this.bottomSurface),this.viewer.scene.primitives.remove(this.wellWall);let t=this.wellData.lerp_pos,i=[];for(let a=0;a<t.length;a++)i.push(Cesium.Cartesian3.fromRadians(t[a].longitude,t[a].latitude,this.excavateMinHeight-e));this.wellData.bottom_pos=i,this.createWell(this.wellData)}}Object.defineProperties(v.prototype,{height:{get:function(){return this._height},set:function(g){this._height=g,this.updateExcavateDepth(g)}}});const P="/assets/broadside-BFff5dkc.jpg",E="/assets/bottom-BnvyvDas.jpg",T={class:"toolPane"},N={style:{"text-align":"center"}},G={__name:"index",setup(g){const e=H(1e3);var t;const i=()=>{viewer.scene.globe.depthTestAgainstTerrain=!0,t=new v({viewer,height:e.value,splitNum:1e3,bottomImg:P,wallImg:E}),t.startCreate()},a=()=>{t.clear(),t=""};return(l,s)=>{const r=d("el-input-number"),o=d("el-form-item"),n=d("el-form"),m=d("el-button");return I(),M(D,null,[p(x),f("div",T,[p(n,null,{default:C(()=>[p(o,{label:"开挖深度"},{default:C(()=>[p(r,{modelValue:e.value,"onUpdate:modelValue":s[0]||(s[0]=u=>e.value=u),min:1,max:1e4},null,8,["modelValue"])]),_:1})]),_:1}),f("div",N,[p(m,{type:"primary",onClick:i},{default:C(()=>s[1]||(s[1]=[w("开挖")])),_:1}),p(m,{type:"warning",onClick:a},{default:C(()=>s[2]||(s[2]=[w("清除")])),_:1})])])],64)}}},V=W(G,[["__scopeId","data-v-54a33e67"]]);export{V as default};
